<?php
    $usehtmleditor = can_use_html_editor();

	// TODO : restrict to endorsable roles...    
    $roles = get_records('role', '', '');
    foreach($roles as $rid => $role){
		$systemcontext = get_context_instance(CONTEXT_SYSTEM);
		$permission = get_field_select('role_capabilities', 'permission', " roleid = $rid AND capability = 'moodle/course:view' AND contextid = $systemcontext->id ");
		if (empty($permission) || $permission != CAP_ALLOW){
			unset($roles[$rid]);
			continue;
		}
	}

	$texts = array();
    if (empty($this->instance->pinned) and $this->instance->pagetype !== 'course-view') {
    	foreach(array_keys($this->config->textids) as $rid){
    		$textkey = "text_$rid";
	        $this->config->$textkey = clean_text($this->config->$textkey, FORMAT_HTML);
	    }
    }
?>
<table cellpadding="9" cellspacing="0">
<tr valign="top">
    <td align="right"><?php print_string('configtitle', 'block_rolespecifichtml'); ?>:</td>
    <td><input type="text" name="title" size="30" value="<?php echo isset($this->config->title)?p($this->config->title):''; ?>" /> (<?php print_string('leaveblanktohide', 'block_rolespecifichtml'); ?>)</td>
</tr>
<tr valign="top">
    <td align="right"><?php print_string('configcontentforall', 'block_rolespecifichtml'); ?>:</td>
    <td><?php 
    	$textkey = "text_all";
    	print_textarea($usehtmleditor, 25, 50, 0, 0, $textkey, @$this->config->$textkey) ?>
    	</td>
</tr>
<tr valign="top">
    <td align="right"><?php print_string('configcontentforany', 'block_rolespecifichtml'); ?>:</td>
    <td><?php 
    	$textkey = "text_0";
    	print_textarea($usehtmleditor, 25, 50, 0, 0, $textkey, @$this->config->$textkey) ?>
    	</td>
</tr>
<?php
foreach($roles as $r){
?>
<tr valign="top">
    <td align="right"><?php print_string('configcontent', 'block_rolespecifichtml', $r->name); ?>:</td>
    <td><?php 
    	$textkey = "text_{$r->id}";
    	print_textarea($usehtmleditor, 25, 50, 0, 0, $textkey, @$this->config->$textkey) ?>
    	<input type="hidden" name="textids[]" value="<?php echo $r->id ?>" />
    	</td>
</tr>
<?php
}
?>
<tr>
    <td colspan="3" align="center">
    <input type="submit" value="<?php print_string('savechanges') ?>" /></td>
</tr>
</table>
<?php if ($usehtmleditor) {
          use_html_editor(); 
      }
?>
